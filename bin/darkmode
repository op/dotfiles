#!/bin/zsh

local sway_theme_path_dark=~/.config/sway/modes/dark.conf
local sway_theme_path_light=~/.config/sway/modes/light.conf

local alacritty_theme_path_dark=~/.config/alacritty/modes/dark.toml
local alacritty_theme_path_light=~/.config/alacritty/modes/light.toml

local mako_theme_path_dark=~/.config/mako/modes/dark
local mako_theme_path_light=~/.config/mako/modes/light

local delta_theme_path_dark=~/.config/delta/modes/dark.gitconfig
local delta_theme_path_light=~/.config/delta/modes/light.gitconfig

local waybar_theme_path_dark=~/.config/waybar/modes/dark.css
local waybar_theme_path_light=~/.config/waybar/modes/light.css

expand_parameter() {
    local parameter="$1_$background"
    print ${(P)parameter};
}

# figure out next mode based on gnome setup
local color_scheme=$(gsettings get org.gnome.desktop.interface color-scheme)
local background
if [[ "$color_scheme" = *dark* ]]; then
    background=light
    rm -f ~/.darkmode
else
    background=dark
    touch ~/.darkmode
fi

local sway_theme_path=$(expand_parameter sway_theme_path);
local alacritty_theme_path=$(expand_parameter alacritty_theme_path);
local mako_theme_path=$(expand_parameter mako_theme_path);
local delta_theme_path=$(expand_parameter delta_theme_path);
local waybar_theme_path=$(expand_parameter waybar_theme_path);

# write cache files
mkdir -p ~/.cache/sway
cat <<EOF > ~/.cache/sway/darkmode.conf
# NOTE: automatically generated by darkmode
include $sway_theme_path
EOF

mkdir -p ~/.cache/alacritty
cat <<EOF > ~/.cache/alacritty/darkmode.toml
# NOTE: automatically generated by darkmode
import = ["$alacritty_theme_path"]
EOF

mkdir -p ~/.cache/mako
echo "# NOTE: automatically generated by darkmode\n" > ~/.cache/mako/config
cat $mako_theme_path >> ~/.cache/mako/config
[ -e ~/.config/mako/config ] || ln -s ~/.cache/mako/config ~/.config/mako/config

mkdir -p ~/.cache/delta
cat <<EOF > ~/.cache/delta/darkmode.gitconfig
# NOTE: automatically generated by darkmode
[include]
  path = $delta_theme_path
EOF

mkdir -p ~/.cache/waybar
cat <<EOF > ~/.cache/waybar/darkmode.css
/* NOTE: automatically generated by darkmode */
@import "$waybar_theme_path";
EOF

gsettings set org.gnome.desktop.interface color-scheme "prefer-$background"

# reload applications
swaymsg reload
touch ~/.config/alacritty/alacritty.toml
makoctl reload

cmd="<C-\\><C-N>::set background=$background<CR>"
parallel "nvim --server {} --remote-send '$cmd'" ::: /var/run/user/$(id -u)/nvim.*
